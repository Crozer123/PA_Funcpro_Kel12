<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agro API Documentation & Tester</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --bg-input: #2c2c2c;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --primary: #00e676; /* Hijau Tani */
            --accent: #2979ff;  /* Biru Link */
            --method-get: #61affe;
            --method-post: #49cc90;
            --method-put: #fca130;
            --method-patch: #50e3c2;
            --method-delete: #f93e3e;
            --border: #333;
        }

        body {
            font-family: 'Segoe UI', monospace, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            background-color: #181818;
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-box {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--primary);
        }

        .token-display {
            font-size: 0.75rem;
            color: var(--primary);
            word-break: break-all;
            background: #000;
            padding: 5px;
            border-radius: 4px;
            margin-top: 5px;
            max-height: 60px;
            overflow-y: auto;
            display: none;
        }

        .nav-header {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .nav-item {
            display: block;
            padding: 8px 10px;
            color: var(--text-main);
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 2px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .nav-item:hover { background: var(--bg-input); }

        /* Main Content */
        main {
            padding: 30px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .section-title {
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 30px;
            margin-top: 40px;
            color: var(--primary);
        }
        .section-title:first-child { margin-top: 0; }

        .api-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .api-card.get { border-left-color: var(--method-get); }
        .api-card.post { border-left-color: var(--method-post); }
        .api-card.patch { border-left-color: var(--method-patch); }
        .api-card.delete { border-left-color: var(--method-delete); }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .method-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: #000;
            font-size: 0.8rem;
        }
        .get .method-badge { background: var(--method-get); }
        .post .method-badge { background: var(--method-post); }
        .patch .method-badge { background: var(--method-patch); }

        .url {
            font-family: 'Consolas', monospace;
            font-size: 1.1rem;
            color: var(--text-main);
        }

        .desc { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px; }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        
        input, textarea {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            box-sizing: border-box;
        }
        
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }
        textarea { height: 100px; resize: vertical; }

        button {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        button:hover { filter: brightness(1.1); }

        .response-box {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            display: none;
            border: 1px solid var(--border);
        }
        .response-box.success { border-color: var(--primary); color: #a5d6a7; }
        .response-box.error { border-color: var(--method-delete); color: #ef9a9a; }

        .id-param { color: var(--method-put); font-weight: bold; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside>
        <h2 style="color:white; margin:0;">üå± Agro API</h2>
        
        <div class="auth-box">
            <h4 style="margin:0 0 10px 0;">üîë Auth Status</h4>
            <div id="auth-status" style="color: #f44336; font-size: 0.9rem;">Belum Login</div>
            <div id="token-display" class="token-display"></div>
            <input type="text" id="manual-token" placeholder="Paste Token..." style="margin-top:10px; font-size:0.8rem;" onchange="saveTokenManual()">
        </div>

        <div>
            <div class="nav-header">Users & Auth</div>
            <a href="#register" class="nav-item">Register</a>
            <a href="#login" class="nav-item">Login</a>
            <a href="#get-me" class="nav-item">Get Me (Profile)</a>
            <a href="#update-me" class="nav-item">Update Profile</a>
        </div>

        <div>
            <div class="nav-header">Forum & QnA</div>
            <a href="#feed" class="nav-item">Get Feed (All)</a>
            <a href="#create-q" class="nav-item">Create Question</a>
            <a href="#detail-q" class="nav-item">Get Detail Question</a>
            <a href="#answer-q" class="nav-item">Add Answer</a>
            <a href="#like-q" class="nav-item">Like Question</a>
            <a href="#fav-q" class="nav-item">Favorite Question</a>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main>

        <!-- SECTION: AUTH -->
        <h2 class="section-title">Authentication & Users</h2>

        <!-- Register -->
        <div class="api-card post" id="register">
            <div class="endpoint-header">
                <span class="method-badge">POST</span>
                <span class="url">/api/v1/auth/register</span>
            </div>
            <p class="desc">Mendaftar user baru.</p>
            <div class="input-group">
                <label>Body (JSON)</label>
                <textarea id="body-register">{
  "name": "Petani Kode",
  "email": "petani@example.com",
  "password": "password123"
}</textarea>
            </div>
            <button onclick="sendRequest('register', 'POST', '/api/v1/auth/register')">Send Request</button>
            <div id="res-register" class="response-box"></div>
        </div>

        <!-- Login -->
        <div class="api-card post" id="login">
            <div class="endpoint-header">
                <span class="method-badge">POST</span>
                <span class="url">/api/v1/auth/login</span>
            </div>
            <p class="desc">Login untuk mendapatkan Token JWT. Token otomatis disimpan.</p>
            <div class="input-group">
                <label>Body (JSON)</label>
                <textarea id="body-login">{
  "email": "petani@example.com",
  "password": "password123"
}</textarea>
            </div>
            <button onclick="sendRequest('login', 'POST', '/api/v1/auth/login')">Login</button>
            <div id="res-login" class="response-box"></div>
        </div>

        <!-- Get Me -->
        <div class="api-card get" id="get-me">
            <div class="endpoint-header">
                <span class="method-badge">GET</span>
                <span class="url">/api/v1/users/me</span>
            </div>
            <p class="desc">Melihat data diri (Butuh Token).</p>
            <button onclick="sendRequest('get-me', 'GET', '/api/v1/users/me', true)">Get Profile</button>
            <div id="res-get-me" class="response-box"></div>
        </div>

        <!-- Update Me -->
        <div class="api-card patch" id="update-me">
            <div class="endpoint-header">
                <span class="method-badge">PATCH</span>
                <span class="url">/api/v1/users/me</span>
            </div>
            <p class="desc">Update nama profil.</p>
            <div class="input-group">
                <label>Body (JSON)</label>
                <textarea id="body-update-me">{
  "name": "Petani Sukses Abadi"
}</textarea>
            </div>
            <button onclick="sendRequest('update-me', 'PATCH', '/api/v1/users/me', true)">Update Profile</button>
            <div id="res-update-me" class="response-box"></div>
        </div>

        <!-- SECTION: FORUM -->
        <h2 class="section-title">Forum & QnA</h2>

        <!-- Get Feed -->
        <div class="api-card get" id="feed">
            <div class="endpoint-header">
                <span class="method-badge">GET</span>
                <span class="url">/api/v1/questions</span>
            </div>
            <p class="desc">Melihat semua pertanyaan. Jika login, status <code>is_liked</code> akan menyesuaikan.</p>
            <button onclick="sendRequest('feed', 'GET', '/api/v1/questions', true)">Get Feed</button>
            <div id="res-feed" class="response-box"></div>
        </div>

        <!-- Create Question -->
        <div class="api-card post" id="create-q">
            <div class="endpoint-header">
                <span class="method-badge">POST</span>
                <span class="url">/api/v1/questions</span>
            </div>
            <p class="desc">Membuat pertanyaan baru.</p>
            <div class="input-group">
                <label>Body (JSON)</label>
                <textarea id="body-create-q">{
  "title": "Daun padi menguning, kenapa ya?",
  "content": "Sudah 3 hari daun benderanya kuning semua. Mohon bantuannya.",
  "category": "Penyakit"
}</textarea>
            </div>
            <button onclick="sendRequest('create-q', 'POST', '/api/v1/questions', true)">Post Question</button>
            <div id="res-create-q" class="response-box"></div>
        </div>

        <!-- Get Detail Question -->
        <div class="api-card get" id="detail-q">
            <div class="endpoint-header">
                <span class="method-badge">GET</span>
                <span class="url">/api/v1/questions/<span class="id-param">{id}</span></span>
            </div>
            <p class="desc">Melihat detail pertanyaan beserta jawaban.</p>
            <div class="input-group">
                <label>Question ID (UUID)</label>
                <input type="text" id="id-detail-q" placeholder="e.g. 550e8400-e29b...">
            </div>
            <button onclick="sendRequestWithID('detail-q', 'GET', '/api/v1/questions/{id}', true)">Get Detail</button>
            <div id="res-detail-q" class="response-box"></div>
        </div>

        <!-- Add Answer -->
        <div class="api-card post" id="answer-q">
            <div class="endpoint-header">
                <span class="method-badge">POST</span>
                <span class="url">/api/v1/questions/<span class="id-param">{id}</span>/answers</span>
            </div>
            <p class="desc">Menambahkan jawaban/komentar ke pertanyaan.</p>
            <div class="input-group">
                <label>Question ID (UUID)</label>
                <input type="text" id="id-answer-q" placeholder="Paste ID Pertanyaan disini...">
            </div>
            <div class="input-group">
                <label>Body (JSON)</label>
                <textarea id="body-answer-q">{
  "content": "Coba cek pangkal batangnya, mungkin ada wereng."
}</textarea>
            </div>
            <button onclick="sendRequestWithID('answer-q', 'POST', '/api/v1/questions/{id}/answers', true)">Submit Answer</button>
            <div id="res-answer-q" class="response-box"></div>
        </div>

        <!-- Like Question -->
        <div class="api-card post" id="like-q">
            <div class="endpoint-header">
                <span class="method-badge">POST</span>
                <span class="url">/api/v1/questions/<span class="id-param">{id}</span>/like</span>
            </div>
            <p class="desc">Like / Unlike pertanyaan.</p>
            <div class="input-group">
                <label>Question ID (UUID)</label>
                <input type="text" id="id-like-q" placeholder="Paste ID Pertanyaan disini...">
            </div>
            <button onclick="sendRequestWithID('like-q', 'POST', '/api/v1/questions/{id}/like', true)">Toggle Like</button>
            <div id="res-like-q" class="response-box"></div>
        </div>

        <!-- Favorite Question -->
        <div class="api-card post" id="fav-q">
            <div class="endpoint-header">
                <span class="method-badge">POST</span>
                <span class="url">/api/v1/questions/<span class="id-param">{id}</span>/favorite</span>
            </div>
            <p class="desc">Simpan ke Favorit.</p>
            <div class="input-group">
                <label>Question ID (UUID)</label>
                <input type="text" id="id-fav-q" placeholder="Paste ID Pertanyaan disini...">
            </div>
            <button onclick="sendRequestWithID('fav-q', 'POST', '/api/v1/questions/{id}/favorite', true)">Toggle Favorite</button>
            <div id="res-fav-q" class="response-box"></div>
        </div>

    </main>

    <script>
        const BASE_URL = "http://localhost:8080";
        let authToken = localStorage.getItem('authToken') || "";

        // Init Check
        updateAuthUI();

        // 1. Core Request Function
        async function sendRequest(elementId, method, endpoint, requiresAuth = false) {
            await executeFetch(elementId, method, BASE_URL + endpoint, requiresAuth, null);
        }

        // 2. Request With ID Param Function
        async function sendRequestWithID(elementId, method, endpointTemplate, requiresAuth = false) {
            const idInput = document.getElementById(`id-${elementId}`);
            const id = idInput.value.trim();

            if (!id) {
                alert("Mohon isi ID terlebih dahulu!");
                return;
            }

            const finalUrl = BASE_URL + endpointTemplate.replace('{id}', id);
            await executeFetch(elementId, method, finalUrl, requiresAuth, null);
        }

        // 3. Main Fetch Logic
        async function executeFetch(elementId, method, url, requiresAuth, forcedBody) {
            const resBox = document.getElementById(`res-${elementId}`);
            resBox.style.display = 'block';
            resBox.innerText = 'Loading...';
            resBox.className = 'response-box';

            // Headers
            const headers = { 'Content-Type': 'application/json' };
            if (requiresAuth && authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            // Body
            let body = forcedBody;
            if (!body && (method === 'POST' || method === 'PATCH' || method === 'PUT')) {
                const bodyInput = document.getElementById(`body-${elementId}`);
                if (bodyInput) {
                    try {
                        body = bodyInput.value;
                        // Validate JSON
                        JSON.parse(body);
                    } catch (e) {
                        resBox.innerText = "Error: JSON Body tidak valid.\n" + e.message;
                        resBox.classList.add('error');
                        return;
                    }
                }
            }

            try {
                const res = await fetch(url, { method, headers, body });
                const data = await res.json();

                // Format JSON output
                const jsonStr = JSON.stringify(data, null, 2);
                resBox.innerText = `Status: ${res.status} ${res.statusText}\n\n${jsonStr}`;

                if (res.ok) {
                    resBox.classList.add('success');
                    
                    // Special Logic: Login Success
                    if (elementId === 'login' && data.data && data.data.token) {
                        authToken = data.data.token;
                        localStorage.setItem('authToken', authToken);
                        updateAuthUI();
                    }
                } else {
                    resBox.classList.add('error');
                }
            } catch (err) {
                resBox.innerText = `Network Error: ${err.message}\nPastikan backend Go berjalan di port 8080.`;
                resBox.classList.add('error');
            }
        }

        // Auth Helpers
        function updateAuthUI() {
            const statusEl = document.getElementById('auth-status');
            const tokenEl = document.getElementById('token-display');
            const inputEl = document.getElementById('manual-token');

            if (authToken) {
                statusEl.innerHTML = "‚úÖ <b>LOGIN SUKSES</b>";
                statusEl.style.color = "#00e676";
                tokenEl.style.display = "block";
                tokenEl.innerText = authToken;
                inputEl.value = authToken;
            } else {
                statusEl.innerHTML = "‚ùå <b>BELUM LOGIN</b>";
                statusEl.style.color = "#f44336";
                tokenEl.style.display = "none";
                inputEl.value = "";
            }
        }

        function saveTokenManual() {
            const val = document.getElementById('manual-token').value.trim();
            if(val) {
                authToken = val;
                localStorage.setItem('authToken', val);
                updateAuthUI();
            } else {
                authToken = "";
                localStorage.removeItem('authToken');
                updateAuthUI();
            }
        }
    </script>
</body>
</html>